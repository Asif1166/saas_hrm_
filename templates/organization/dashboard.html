{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - {{ organization.name }}{% endblock %}

{% block content %}
<div class="main-content">
    <div class="dashboard-breadcrumb mb-25">
        <h2>Dashboard</h2>
        <div class="input-group dashboard-filter">
            <input type="text" class="form-control" name="basic" id="dashboardFilter" readonly value="{{ today|date:'F d, Y' }}">
            <label for="dashboardFilter" class="input-group-text"><i class="fa-solid fa-calendar-days"></i></label>
        </div>
    </div>
    
    <div class="row mb-25">
        <!-- Total Employees -->
        <div class="col-lg-3 col-6 col-xs-12">
            <div class="dashboard-top-box dashboard-top-box-2 rounded border-0 panel-bg">
                <div class="left">
                    <p class="d-flex justify-content-between mb-2">Total Employees</p>
                    <h3 class="fw-normal">{{ total_employees }}</h3>
                    <p class="text-muted"><small>{{ total_departments }} Departments</small></p>
                </div>
                <div class="right">
                    <div class="part-icon text-solid rounded">
                        <span><i class="fa-solid fa-users"></i></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Summary -->
        <div class="col-lg-3 col-6 col-xs-12">
            <div class="dashboard-top-box dashboard-top-box-2 rounded border-0 panel-bg">
                <div class="left">
                    <p class="d-flex justify-content-between mb-2">This Month Attendance</p>
                    <h3 class="fw-normal">
                        <span class="badge bg-success me-1">P: {{ present_count }}</span>
                        <span class="badge bg-warning me-1">L: {{ late_count }}</span>
                        <span class="badge bg-danger">A: {{ absent_count }}</span>
                    </h3>
                    <p class="text-muted"><small>Current month</small></p>
                </div>
                <div class="right">
                    <div class="part-icon text-solid rounded">
                        <span><i class="fa-solid fa-calendar-check"></i></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave Applications -->
        <div class="col-lg-3 col-6 col-xs-12">
            <div class="dashboard-top-box dashboard-top-box-2 rounded border-0 panel-bg">
                <div class="left">
                    <p class="d-flex justify-content-between mb-2">Leave Applications</p>
                    <h3 class="fw-normal">{{ total_leaves }}</h3>
                    <p class="text-muted">
                        <small>
                            <span class="badge bg-warning me-1">P: {{ pending_leaves }}</span>
                            <span class="badge bg-success me-1">A: {{ approved_leaves }}</span>
                            <span class="badge bg-danger">R: {{ rejected_leaves }}</span>
                        </small>
                    </p>
                </div>
                <div class="right">
                    <div class="part-icon text-solid rounded">
                        <span><i class="fa-solid fa-calendar-minus"></i></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branches -->
        <div class="col-lg-3 col-6 col-xs-12">
            <div class="dashboard-top-box dashboard-top-box-2 rounded border-0 panel-bg">
                <div class="left">
                    <p class="d-flex justify-content-between mb-2">Branches</p>
                    <h3 class="fw-normal">{{ total_branches }}</h3>
                    <p class="text-muted"><small>Active branches</small></p>
                </div>
                <div class="right">
                    <div class="part-icon text-solid rounded">
                        <span><i class="fa-solid fa-building"></i></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Today's Attendance -->
        <div class="col-xxl-8">
            <div class="panel">
                <div class="panel-header">
                    <h5>Today's Attendance ({{ today|date:"F d, Y" }})</h5>
                    <div class="btn-box">
                        <a href="{% url 'hrm:attendance_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="panel-body">
                    {% if today_attendance %}
                    <table class="table table-hover attendance-table digi-dataTable" id="todayAttendanceTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Department</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Status</th>
                                <th>Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in today_attendance %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if record.employee.profile_picture %}
                                        <img src="{{ record.employee.profile_picture.url }}" class="rounded-circle me-2" width="32" height="32" alt="{{ record.employee.full_name }}">
                                        {% else %}
                                        <div class="avatar-placeholder rounded-circle me-2 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                            {{ record.employee.first_name|first }}{{ record.employee.last_name|first }}
                                        </div>
                                        {% endif %}
                                        <div>
                                            <strong>{{ record.employee.full_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ record.employee.employee_id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if record.employee.department %}
                                    {{ record.employee.department.name }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ record.check_in_time|default:"-" }}</td>
                                <td>{{ record.check_out_time|default:"-" }}</td>
                                <td>
                                    {% if record.status == 'present' %}
                                    <span class="badge bg-success rounded px-2">Present</span>
                                    {% elif record.status == 'late' %}
                                    <span class="badge bg-warning rounded px-2">Late</span>
                                    {% elif record.status == 'absent' %}
                                    <span class="badge bg-danger rounded px-2">Absent</span>
                                    {% elif record.status == 'half_day' %}
                                    <span class="badge bg-info rounded px-2">Half Day</span>
                                    {% else %}
                                    <span class="badge bg-secondary rounded px-2">{{ record.status|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ record.working_hours }}h</strong>
                                    {% if record.overtime_hours > 0 %}
                                    <br>
                                    <small class="text-success">+{{ record.overtime_hours }}h OT</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fa-solid fa-calendar-xmark fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No attendance records for today</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Activities & Upcoming Holidays -->
        <div class="col-xxl-4">
            <div class="row">
                <!-- Recent Leave Requests -->
                <div class="col-xxl-12 col-md-6">
                    <div class="panel">
                        <div class="panel-header">
                            <h5>Recent Leave Requests</h5>
                            <div class="btn-box">
                                <a href="{% url 'hrm:leave_list' %}" class="btn btn-sm btn-primary">View All</a>
                            </div>
                        </div>
                        <div class="panel-body">
                            {% if recent_leaves %}
                            <ul class="hr-recent-activity">
                                {% for leave in recent_leaves %}
                                <li>
                                    <div class="left">
                                        <span class="activity-name">{{ leave.employee.full_name }}</span>
                                        <span class="activity-short">
                                            {{ leave.get_leave_type_display }} - 
                                            {{ leave.start_date }} to {{ leave.end_date }}
                                            ({{ leave.days_requested }} days)
                                        </span>
                                    </div>
                                    <div class="right">
                                        <span class="activity-time">{{ leave.created_at|timesince }} ago</span>
                                        <span class="badge 
                                            {% if leave.status == 'pending' %}bg-warning
                                            {% elif leave.status == 'approved' %}bg-success
                                            {% elif leave.status == 'rejected' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ leave.get_status_display }}
                                        </span>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-center py-3">
                                <p class="text-muted">No recent leave requests</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Upcoming Holidays -->
                <div class="col-xxl-12 col-md-6">
                    <div class="panel">
                        <div class="panel-header">
                            <h5>Upcoming Holidays</h5>
                        </div>
                        <div class="panel-body">
                            {% if upcoming_holidays %}
                            <ul class="hr-notice-board">
                                {% for holiday in upcoming_holidays %}
                                <li>
                                    <div class="activity-box">
                                        <div class="date-box date-box-lg">
                                            <span>{{ holiday.date|date:"d" }}</span>
                                            <span>{{ holiday.date|date:"M" }}</span>
                                        </div>
                                        <div class="part-txt">
                                            <span>{{ holiday.name }}</span>
                                            <span class="text-muted">{{ holiday.date|date:"l" }}</span>
                                            {% if holiday.is_recurring %}
                                            <small class="text-info">Yearly</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-center py-3">
                                <p class="text-muted">No upcoming holidays</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Employees -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="panel">
                <div class="panel-header">
                    <h5>Recently Added Employees</h5>
                    <div class="btn-box">
                        <a href="{% url 'hrm:employee_list' %}" class="btn btn-sm btn-outline-primary">View All Employees</a>
                    </div>
                </div>
                <div class="panel-body">
                    {% if recent_employees %}
                    <div class="row">
                        {% for employee in recent_employees %}
                        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                            <div class="employee-card text-center">
                                <div class="employee-avatar mb-3">
                                    {% if employee.profile_picture %}
                                    <img src="{{ employee.profile_picture.url }}" class="rounded-circle" width="80" height="80" alt="{{ employee.full_name }}">
                                    {% else %}
                                    <div class="avatar-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; font-size: 24px;">
                                        {{ employee.first_name|first }}{{ employee.last_name|first }}
                                    </div>
                                    {% endif %}
                                </div>
                                <h6 class="mb-1">{{ employee.full_name }}</h6>
                                <p class="text-muted small mb-1">{{ employee.employee_id }}</p>
                                <p class="text-muted small mb-2">
                                    {% if employee.designation %}
                                    {{ employee.designation.name }}
                                    {% else %}
                                    <span class="text-muted">No designation</span>
                                    {% endif %}
                                </p>
                                <span class="badge 
                                    {% if employee.employment_status == 'active' %}bg-success
                                    {% elif employee.employment_status == 'on_leave' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ employee.get_employment_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fa-solid fa-users fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No employees found</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-placeholder {
    font-weight: bold;
    text-transform: uppercase;
}
.employee-card {
    padding: 20px;
    border: 1px solid #e0e6ef;
    border-radius: 8px;
    transition: all 0.3s ease;
}
.employee-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}
.hr-recent-activity li {
    padding: 12px 0;
    border-bottom: 1px solid #e0e6ef;
}
.hr-recent-activity li:last-child {
    border-bottom: none;
}
</style>

<script>
$(document).ready(function() {
    // Initialize DataTable for today's attendance
    $('#todayAttendanceTable').DataTable({
        "pageLength": 5,
        "lengthMenu": [5, 10, 25, 50],
        "order": [],
        "responsive": true
    });
});
</script>
{% endblock %}