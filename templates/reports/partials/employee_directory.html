<!-- templates/reports/partials/employee_directory.html -->
<div class="table-responsive" id="employeeDirectoryTable">
    <table class="table table-bordered table-striped">
        <thead class="table-secondary">
            <tr>
                <th width="50">SL No</th>
                <th>Employee ID</th>
                <th>Full Name</th>
                <th>Department</th>
                <th>Designation</th>
                <th>Branch</th>
                <th>Work Phone</th>
                <th>Personal Email</th>
                <th>Status</th>
                <th>Hire Date</th>
                <!-- <th>Reporting Manager</th> -->
            </tr>
        </thead>
        <tbody>
            {% for employee in report_data.data %}
            <tr>
                <td class="text-center">
                    <strong>
                        {% if report_data.pagination.show_all %}
                            {{ forloop.counter }}
                        {% else %}
                            {{ report_data.pagination.start_index|add:forloop.counter0 }}
                        {% endif %}
                    </strong>
                </td>
                <td><strong>{{ employee.employee_id }}</strong></td>
                <td>{{ employee.full_name }}</td>
                <td>{{ employee.department }}</td>
                <td>{{ employee.designation }}</td>
                <td>{{ employee.branch }}</td>
                <td>{{ employee.work_phone }}</td>
                <td>{{ employee.personal_email }}</td>
                <td>
                    <span class="badge {% if employee.employment_status == 'Active' %}bg-success{% else %}bg-warning{% endif %}">
                        {{ employee.employment_status }}
                    </span>
                </td>
                <td>{{ employee.hire_date }}</td>
                <!-- <td>{{ employee.reporting_manager }}</td> -->
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="text-center text-muted py-4">
                    <i class="fas fa-users fa-2x mb-3"></i><br>
                    No employees found matching your criteria
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Simple Pagination Controls -->
{% if not report_data.pagination.show_all and report_data.pagination.total_pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if report_data.pagination.has_previous %}
        <li class="page-item">
            {% with prev_page=report_data.pagination.current_page|add:"-1" %}
            <a class="page-link" href="?page={{ prev_page }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
            {% endwith %}
        </li>
        {% endif %}

        <!-- Show limited page numbers -->
        <li class="page-item active">
            <span class="page-link">
                Page {{ report_data.pagination.current_page }} of {{ report_data.pagination.total_pages }}
                {% if report_data.pagination.start_index and report_data.pagination.end_index %}
                (Showing {{ report_data.pagination.start_index }} to {{ report_data.pagination.end_index }} of {{ report_data.total_employees }})
                {% endif %}
            </span>
        </li>

        {% if report_data.pagination.has_next %}
        <li class="page-item">
            {% with next_page=report_data.pagination.current_page|add:"1" %}
            <a class="page-link" href="?page={{ next_page }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
            {% endwith %}
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Show All Button -->
{% if not report_data.pagination.show_all %}
<div class="row mt-3">
    <div class="col-12 text-center">
        <a href="?show_all=true{% for key, value in request.GET.items %}{% if key != 'show_all' and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
           class="btn btn-outline-primary btn-sm">
            <i class="fas fa-list-ol me-1"></i> Show All Employees ({{ report_data.total_employees }})
        </a>
    </div>
</div>
{% else %}
<!-- Show Paginated View Button -->
<div class="row mt-3">
    <div class="col-12 text-center">
        <a href="?show_all=false&page=1{% for key, value in request.GET.items %}{% if key != 'show_all' and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
           class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-file me-1"></i> Show Paginated View
        </a>
    </div>
</div>
{% endif %}

<!-- Summary -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Employees
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ report_data.total_employees }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Showing
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ report_data.data|length }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-eye fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Header (Hidden by default) -->
<div id="printHeader" style="display: none;">
    <div style="text-align: center; margin-bottom: 20px; font-family: Arial, sans-serif;">
        <h2 style="margin: 0 0 5px 0; font-size: 24px;">Employee Directory Report</h2>
        <p style="margin: 0; color: #666; font-size: 14px;">
            Generated on: {{ report_data.generated_on }} | Total Employees: {{ report_data.total_employees }}
        </p>
    </div>
</div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Print functionality using Canvas
document.getElementById('printInvoice').addEventListener('click', function() {
    printExactTableWithCanvas();
});

// Export to Excel
document.getElementById('exportExcel').addEventListener('click', function() {
    alert('Excel export functionality will be implemented');
});

// Export to PDF
document.getElementById('exportPDF').addEventListener('click', function() {
    alert('PDF export functionality will be implemented');
});

// Auto-submit form when select changes
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('select[name]');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('reportFilters').submit();
        });
    });
    
    const pageSizeSelect = document.querySelector('select[name="page_size"]');
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
            document.getElementById('reportFilters').submit();
        });
    }
});

// Function to print the exact table using Canvas
function printExactTableWithCanvas() {
    const tableElement = document.getElementById('employeeDirectoryTable');
    const printHeader = document.getElementById('printHeader');
    
    // Create a temporary container for printing
    const printContainer = document.createElement('div');
    printContainer.style.cssText = `
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 10000;
        padding: 20px;
        box-sizing: border-box;
        overflow: auto;
    `;
    
    // Clone the table and header
    const tableClone = tableElement.cloneNode(true);
    const headerClone = printHeader.cloneNode(true);
    
    // Apply print styles to the clone
    tableClone.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
    `;
    
    // Show the header
    headerClone.style.display = 'block';
    
    // Add to print container
    printContainer.appendChild(headerClone);
    printContainer.appendChild(tableClone);
    
    // Add to body
    document.body.appendChild(printContainer);
    
    // Use html2canvas to capture the exact table
    html2canvas(printContainer, {
        scale: 2, // High quality
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        width: printContainer.scrollWidth,
        height: printContainer.scrollHeight,
        scrollX: 0,
        scrollY: 0,
        windowWidth: printContainer.scrollWidth,
        windowHeight: printContainer.scrollHeight
    }).then(canvas => {
        // Remove the temporary container
        document.body.removeChild(printContainer);
        
        // Create print window
        const printWindow = window.open('', '_blank');
        const today = new Date().toLocaleDateString();
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Employee Directory Report</title>
                <style>
                    body { 
                        margin: 0; 
                        padding: 20px; 
                        font-family: Arial, sans-serif;
                        background: white;
                    }
                    .print-container { 
                        width: 100%; 
                        text-align: center;
                    }
                    .print-image { 
                        max-width: 100%; 
                        height: auto;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    }
                    @media print {
                        body { 
                            margin: 0; 
                            padding: 0; 
                        }
                        .print-container { 
                            page-break-inside: avoid;
                        }
                        .print-image {
                            box-shadow: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    <img src="${canvas.toDataURL('image/png')}" class="print-image" alt="Employee Directory Report">
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        // Close window after print
                        setTimeout(function() {
                            window.close();
                        }, 500);
                    }
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
        
    }).catch(error => {
        console.error('Error generating print image:', error);
        // Remove temporary container on error
        if (document.body.contains(printContainer)) {
            document.body.removeChild(printContainer);
        }
        // Fallback to browser print
        fallbackPrint();
    });
}

// Fallback print function
function fallbackPrint() {
    const originalContents = document.body.innerHTML;
    const tableElement = document.getElementById('employeeDirectoryTable');
    const printHeader = document.getElementById('printHeader');
    
    // Create print content
    const printContent = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
            ${printHeader.innerHTML}
            ${tableElement.outerHTML}
        </div>
    `;
    
    // Replace body with print content
    document.body.innerHTML = printContent;
    
    // Add print styles
    const style = document.createElement('style');
    style.innerHTML = `
        body { margin: 0; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa !important; font-weight: bold; }
        .badge { border: 1px solid #000; padding: 2px 6px; font-size: 10px; }
        @media print { 
            body { margin: 0; padding: 0; }
            table { font-size: 12px; }
        }
    `;
    document.head.appendChild(style);
    
    // Print
    window.print();
    
    // Restore original content
    document.body.innerHTML = originalContents;
    window.location.reload();
}

// Simple table print (alternative method)
function simpleTablePrint() {
    const tableElement = document.getElementById('employeeDirectoryTable');
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Employee Directory</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #000; padding: 8px; }
                th { background: #f8f9fa; font-weight: bold; }
            </style>
        </head>
        <body>
            <h2>Employee Directory Report</h2>
            <p>Generated on: ${new Date().toLocaleDateString()}</p>
            ${tableElement.outerHTML}
            <script>
                window.onload = function() { window.print(); }
            <\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
</script>
