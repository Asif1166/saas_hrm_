{% load humanize %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-chart-line me-1"></i> Monthly Payroll Trends
        </h6>
    </div>
    <div class="card-body">
        <div class="chart-area">
            <canvas id="monthlyTrendsChart" height="100"></canvas>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Monthly Trends Details</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="table-light">
                    <tr>
                        <th>Month</th>
                        <th class="text-end">Gross Salary</th>
                        <th class="text-end">Net Salary</th>
                        <th class="text-end">Deductions</th>
                        <th class="text-end">Employees</th>
                        <th class="text-end">MoM Growth</th>
                        <th class="text-end">Deduction Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month in report_data.monthly_trends %}
                    <tr>
                        <td><strong>{{ month.month }}</strong></td>
                        <td class="text-end">৳{{ month.total_gross|floatformat:0|intcomma }}</td>
                        <td class="text-end">৳{{ month.total_net|floatformat:0|intcomma }}</td>
                        <td class="text-end">৳{{ month.total_deductions|floatformat:0|intcomma }}</td>
                        <td class="text-end">{{ month.employee_count }}</td>
                        <td class="text-end {% if month.mom_growth >= 0 %}text-success{% else %}text-danger{% endif %}">
                            <i class="fas fa-arrow-{% if month.mom_growth >= 0 %}up{% else %}down{% endif %} me-1"></i>
                            {{ month.mom_growth|floatformat:1 }}%
                        </td>
                        <td class="text-end">{{ month.deduction_rate|floatformat:1 }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if report_data.monthly_trends %}
                <tfoot class="table-light">
                    <tr>
                        <th>Total/Average</th>
                        <th class="text-end">৳{{ report_data.summary.total_gross_payroll|floatformat:0|intcomma }}</th>
                        <th class="text-end">৳{{ report_data.summary.total_net_payroll|floatformat:0|intcomma }}</th>
                        <th class="text-end">৳{{ report_data.summary.total_deductions|floatformat:0|intcomma }}</th>
                        <th class="text-end">{{ report_data.monthly_trends|length }}</th>
                        <th class="text-end">{{ report_data.summary.overall_growth_rate|floatformat:1 }}%</th>
                        <th class="text-end">
                            {% with total_deductions=report_data.summary.total_deductions total_gross=report_data.summary.total_gross_payroll %}
                            {{ total_deductions|div:total_gross|mul:100|floatformat:1 }}%
                            {% endwith %}
                        </th>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<script>
// Monthly Trends Chart
const monthlyTrendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
const monthlyTrendsChart = new Chart(monthlyTrendsCtx, {
    type: 'line',
    data: {
        labels: [{% for month in report_data.monthly_trends %}'{{ month.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [
            {
                label: 'Gross Salary',
                data: [{% for month in report_data.monthly_trends %}{{ month.total_gross }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.4,
                fill: true
            },
            {
                label: 'Net Salary',
                data: [{% for month in report_data.monthly_trends %}{{ month.total_net }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#1cc88a',
                backgroundColor: 'rgba(28, 200, 138, 0.1)',
                tension: 0.4,
                fill: true
            }
        ]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '৳' + (value/100000).toFixed(1) + 'L';
                    }
                }
            }
        }
    }
});
</script>