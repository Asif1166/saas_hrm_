{% extends 'base.html' %}
{% load static %}
{% load report_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="main-content">
    <div class="row">
        <div class="col-12">
            <div class="panel">
                <!-- Panel Header -->
                <div class="panel-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-line me-2"></i>{{ page_title }}</h5>
                    <div class="btn-box d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-primary" id="printReport">
                            <i class="fa-solid fa-print"></i> Print
                        </button>
                        <button class="btn btn-sm btn-success" id="exportExcel">
                            <i class="fa-solid fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-sm btn-danger" id="exportPDF">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <!-- Analytics Navigation -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-body py-2">
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="{% url 'report:analytics_dashboard' %}" 
                                       class="btn {% if 'dashboard' in request.path %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                                    </a>
                                    <a href="{% url 'report:cost_trends_report' %}" 
                                       class="btn {% if 'cost-trends' in request.path %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                        <i class="fas fa-chart-line me-1"></i>Cost Trends
                                    </a>
                                    <a href="{% url 'report:overtime_analysis' %}" 
                                       class="btn {% if 'overtime-analysis' in request.path %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                        <i class="fas fa-clock me-1"></i>Overtime Analysis
                                    </a>
                                    <a href="{% url 'report:bonus_analysis' %}" 
                                       class="btn {% if 'bonus-analysis' in request.path %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                        <i class="fas fa-gift me-1"></i>Bonus Analysis
                                    </a>
                                    <a href="{% url 'report:tax_projections' %}" 
                                       class="btn {% if 'tax-projections' in request.path %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                        <i class="fas fa-receipt me-1"></i>Tax Projections
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-body">
                    <!-- Filter Section -->
                    <div class="table-filter-option mb-4">
                        <div class="card shadow">
                            <div class="card-header py-1 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-filter me-1"></i> Analytics Filters
                                </h6>
                            </div>
                            <div class="card-body">
                                <form method="get" id="analyticsFilters" class="row g-3">
                                    <!-- Date Range -->
                                    <div class="col-md-3">
                                        <label class="form-label">Start Date</label>
                                        <input type="date" name="start_date" class="form-control form-control-sm" 
                                               value="{{ current_filters.start_date|default:'' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">End Date</label>
                                        <input type="date" name="end_date" class="form-control form-control-sm" 
                                               value="{{ current_filters.end_date|default:'' }}">
                                    </div>

                                    <!-- Department Filter -->
                                    <div class="col-md-3">
                                        <label class="form-label">Department</label>
                                        <select name="department" class="form-select form-select-sm">
                                            <option value="">All Departments</option>
                                            {% for dept in departments %}
                                                <option value="{{ dept.id }}" {% if current_filters.department == dept.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ dept.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Additional Filters for Specific Reports -->
                                    {% if designations %}
                                    <div class="col-md-3">
                                        <label class="form-label">Designation</label>
                                        <select name="designation" class="form-select form-select-sm">
                                            <option value="">All Designations</option>
                                            {% for desg in designations %}
                                                <option value="{{ desg.id }}" {% if current_filters.designation == desg.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ desg.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}

                                    <!-- Employee Filter for Specific Reports -->
                                    {% if 'bonus' in request.path or 'overtime' in request.path %}
                                    <div class="col-md-3">
                                        <label class="form-label">Employee ID</label>
                                        <input type="text" name="employee_id" class="form-control form-control-sm" 
                                               placeholder="Enter Employee ID" value="{{ current_filters.employee_id|default:'' }}">
                                    </div>
                                    {% endif %}

                                    <!-- Action Buttons -->
                                    <div class="col-12 d-flex justify-content-start align-items-center mt-2">
                                        <button type="submit" class="btn btn-sm btn-primary me-2">
                                            <i class="fas fa-chart-bar me-1"></i> Generate Report
                                        </button>
                                        <a href="{{ request.path }}" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-refresh me-1"></i> Clear Filters
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Report Content -->
                    {% block analytics_content %}
                    {% endblock %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Print functionality
document.getElementById('printReport').addEventListener('click', function() {
    printAnalyticsReport();
});

// Export to Excel
document.getElementById('exportExcel').addEventListener('click', function() {
    exportToExcel();
});

// Export to PDF
document.getElementById('exportPDF').addEventListener('click', function() {
    exportToPDF();
});

// Auto-submit form when select changes
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('select[name]');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('analyticsFilters').submit();
        });
    });
});

// Print function for analytics reports
function printAnalyticsReport() {
    const reportContent = document.querySelector('.analytics-content');
    
    if (!reportContent) {
        alert('No content available for printing');
        return;
    }

    const printWindow = window.open('', '_blank');
    const reportTitle = '{{ page_title }}';
    const generatedOn = '{{ report_data.generated_on|default:"" }}';
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${reportTitle}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    background: white; 
                    color: black;
                }
                .print-header { 
                    text-align: center; 
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 10px;
                }
                .print-header h1 { 
                    margin: 0 0 5px 0; 
                    font-size: 24px; 
                    color: #333;
                }
                .print-header .subtitle { 
                    color: #666; 
                    font-size: 14px;
                }
                .kpi-grid { 
                    display: grid; 
                    grid-template-columns: repeat(4, 1fr); 
                    gap: 15px; 
                    margin: 20px 0; 
                }
                .kpi-card { 
                    background: #f8f9fa; 
                    padding: 15px; 
                    border-radius: 8px; 
                    text-align: center;
                    border-left: 4px solid #007bff;
                }
                .kpi-value { 
                    font-size: 20px; 
                    font-weight: bold; 
                    margin: 5px 0;
                }
                .kpi-label { 
                    font-size: 12px; 
                    color: #666;
                }
                .chart-placeholder { 
                    background: #f8f9fa; 
                    padding: 40px; 
                    text-align: center; 
                    margin: 20px 0;
                    border: 1px dashed #ccc;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 8px; 
                    text-align: left;
                }
                th { 
                    background-color: #f8f9fa; 
                    font-weight: bold;
                }
                .trend-positive { color: #28a745; }
                .trend-negative { color: #dc3545; }
                @media print {
                    body { margin: 0; padding: 10px; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${reportTitle}</h1>
                <div class="subtitle">
                    Generated on: ${generatedOn} | 
                    Period: {{ report_data.analysis_period.start_date|default:"" }} to {{ report_data.analysis_period.end_date|default:"" }}
                </div>
            </div>
            ${reportContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}

function exportToExcel() {
    alert('Excel export functionality will be implemented');
    // Implementation for Excel export
}

function exportToPDF() {
    alert('PDF export functionality will be implemented');
    // Implementation for PDF export
}
</script>
{% endblock %}