{% extends 'base.html' %}
{% load static %}
{% load organization_tags %}

{% block title %}Organizations{% endblock %}

{% block content %}

<!-- main content start -->
<div class="main-content">

    <div class="row">
        <div class="col-12">
            <div class="panel">
                <div class="panel-header">
                    <h5>All Organizations</h5>
                    <div class="btn-box d-flex flex-wrap gap-2">
                        <div id="tableSearch"></div>
                        <a href="{% url 'super_admin:organization_list' %}" class="btn btn-sm btn-icon btn-outline-primary"><i class="fa-solid fa-arrows-rotate"></i></a>
                        <a href="{% url 'super_admin:create_organization' %}" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus"></i> Add New</a>
                   
             
                      
                    </div>
                </div>
                <div class="panel-body">
                    <!-- Filter Section -->
                    <div class="table-filter-option">
                        <form method="get" class="row g-3">
                            <div class="col-xl-10 col-9 col-xs-12">
                                <div class="row g-3">
                                    <div class="col">
                                        <select name="status" class="form-control form-control-sm">
                                            <option value="">All Status</option>
                                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                                            <option value="suspended" {% if status_filter == 'suspended' %}selected{% endif %}>Suspended</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <select name="plan" class="form-control form-control-sm">
                                            <option value="">All Plans</option>
                                            <option value="basic" {% if plan_filter == 'basic' %}selected{% endif %}>Basic</option>
                                            <option value="premium" {% if plan_filter == 'premium' %}selected{% endif %}>Premium</option>
                                            <option value="enterprise" {% if plan_filter == 'enterprise' %}selected{% endif %}>Enterprise</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <input type="text" name="search" class="form-control form-control-sm" placeholder="Search organization name or email" value="{{ search_query|default:'' }}">
                                    </div>
                                    <div class="col">
                                        <button type="submit" class="btn btn-sm btn-primary"><i class="fa-solid fa-filter"></i> Filter</button>
                                    </div>
                                    <div class="col">
                                        <a href="{% url 'super_admin:organization_list' %}" class="btn btn-sm btn-outline-secondary">Clear</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-3 col-xs-12 d-flex justify-content-end">
                                <div id="organizationTableLength"></div>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-dashed table-hover digi-dataTable all-organization-table table-striped" id="allOrganizationTable">
                            <thead>
                                <tr id="tableHeader">
                                    <th class="no-sort">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="markAllOrganization">
                                        </div>
                                    </th>
                                    <th>SL</th>
                                    <th>Action</th>
                                    <th>Organization</th>
                                    <th>Contact</th>
                                    <th>Status</th>
                                    <th>Plan</th>
                                    <th>Employees</th>
                                    <th>Created Date</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                {% for org in page_obj %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input row-checkbox" type="checkbox" value="{{ org.id }}">
                                        </div>
                                    </td>
                                    <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                    <td>
                                        <div class="digi-dropdown dropdown d-inline-block">
                                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="dropdown" aria-expanded="false">
                                                Action <i class="fa-solid fa-angle-down"></i>
                                            </button>
                                            <ul class="digi-dropdown-menu dropdown-menu dropdown-slim dropdown-menu-sm">
                                                <li>
                                                    <a href="{% url 'super_admin:organization_detail' org.id %}" class="dropdown-item">
                                                        <span class="dropdown-icon"><i class="fa-solid fa-eye"></i></span> View Details
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="{% url 'super_admin:update_organization' org.id %}" class="dropdown-item">
                                                        <span class="dropdown-icon"><i class="fa-solid fa-pen-to-square"></i></span> Edit
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#" class="dropdown-item">
                                                        <span class="dropdown-icon"><i class="fa-solid fa-users"></i></span> Manage Users
                                                    </a>
                                                </li>
                                                {% if org.status == 'active' %}
                                                <li>
                                                    <a href="#" class="dropdown-item text-warning" 
                                                       onclick="return confirm('Are you sure you want to suspend this organization?')">
                                                        <span class="dropdown-icon"><i class="fa-solid fa-pause"></i></span> Suspend
                                                    </a>
                                                </li>
                                                {% elif org.status == 'suspended' %}
                                                <li>
                                                    <a href="#" class="dropdown-item text-success" 
                                                       onclick="return confirm('Are you sure you want to activate this organization?')">
                                                        <span class="dropdown-icon"><i class="fa-solid fa-play"></i></span> Activate
                                                    </a>
                                                </li>
                                                {% endif %}
                                                <li>
                                                    <a href="#" class="dropdown-item text-danger" 
                                                       onclick="return confirm('Are you sure you want to delete this organization?')">
                                                        <span class="dropdown-icon"><i class="fa-solid fa-trash-can"></i></span> Delete
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if org.logo %}
                                                <img src="{{ org.logo.url }}" alt="{{ org.name }}" class="avatar-sm rounded me-3">
                                            {% else %}
                                                <div class="avatar-sm rounded bg-primary-subtle me-3">
                                                    <span class="avatar-title rounded bg-primary text-white font-size-14">
                                                        {{ org.name|first|upper }}
                                                    </span>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ org.name }}</h6>
                                                <p class="text-muted mb-0">{{ org.slug }}</p>
                                                {% if org.description %}
                                                    <small class="text-muted">{{ org.description|truncatechars:30 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <p class="mb-1">{{ org.email }}</p>
                                            {% if org.phone %}
                                                <small class="text-muted">{{ org.phone }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if org.status == 'active' %}
                                            <span class="badge bg-success">Active</span>
                                        {% elif org.status == 'inactive' %}
                                            <span class="badge bg-warning">Inactive</span>
                                        {% else %}
                                            <span class="badge bg-danger">Suspended</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ org.subscription_plan|title }}</span>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="fw-medium">{{ org.employee_count }}</span>
                                            <small class="text-muted">/ {{ org.max_employees }}</small>
                                        </div>
                                    </td>
                                    <td>{{ org.created_at|date:"M d, Y" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fa-solid fa-building fa-2x mb-3"></i>
                                            <p>No organizations found.</p>
                                            <a href="{% url 'super_admin:create_organization' %}" class="btn btn-sm btn-primary">Add First Organization</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% include "pagination.html" %}

                </div>
            </div>
        </div>
    </div>

</div>
<!-- main content end -->

<script>
// Initialize DataTable
$(document).ready(function() {
    $('.all-organization-table').DataTable({
        "pageLength": 10,
        "lengthMenu": [10, 25, 50, 100],
        "order": [],
        "responsive": true,
        "dom": '<"table-top-control"lf>rt<"table-bottom-control"ip>',
        "columnDefs": [
            { "orderable": false, "targets": "no-sort" },
            { "orderable": false, "targets": [0, 1, 2] } // SL No, Checkbox, Action columns
        ]
    });

    // Select all functionality
    $('#markAllOrganization').change(function() {
        $('.row-checkbox').prop('checked', this.checked);
        toggleDeleteButton();
    });

    // Individual checkbox change
    $('.row-checkbox').change(function() {
        if (!this.checked) {
            $('#markAllOrganization').prop('checked', false);
        }
        toggleDeleteButton();
    });

    // Toggle delete button based on selection
    function toggleDeleteButton() {
        const checkedCount = $('.row-checkbox:checked').length;
        if (checkedCount > 0) {
            $('#deleteSelectedBtn').show();
        } else {
            $('#deleteSelectedBtn').hide();
        }
    }

    // Delete selected organizations
    $('#deleteSelectedBtn').click(function() {
        const selectedIds = $('.row-checkbox:checked').map(function() {
            return this.value;
        }).get();

        if (selectedIds.length === 0) {
            alert('Please select at least one organization to delete.');
            return;
        }

        if (confirm(`Are you sure you want to delete ${selectedIds.length} selected organization(s)?`)) {
            const deleteUrl = $(this).data('delete-url');
            
            $.ajax({
                url: deleteUrl,
                type: 'POST',
                data: {
                    'organization_ids': selectedIds,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error deleting organizations: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error deleting organizations. Please try again.');
                }
            });
        }
    });
});
</script>

<style>
.avatar-sm {
    width: 40px;
    height: 40px;
    object-fit: cover;
}

.avatar-title {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-weight: 600;
    font-size: 14px;
}

.table-filter-option {
    margin-bottom: 20px;
}

.all-organization-table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.digi-dropdown-menu {
    min-width: 180px;
}

.badge {
    font-size: 0.75em;
    padding: 4px 8px;
}
</style>

{% endblock %}